{% extends 'backend/base/staff_base.html' %}
{% load static %}
{% load humanize %}

{% block title %}Tableau de Bord Staff - Vid√©-Grenier Kamer{% endblock %}

{% block content %}
<div class="space-y-8">
    <!-- Welcome Section -->
    <div class="bg-gradient-to-r from-purple-600 via-purple-700 to-orange-800 rounded-2xl p-8 text-white relative overflow-hidden">
        <div class="absolute top-0 right-0 w-64 h-64 bg-white bg-opacity-10 rounded-full transform translate-x-32 -translate-y-32 blur-2xl"></div>
        <div class="relative z-10">
            <h1 class="text-3xl font-bold mb-4">
                Bienvenue, {{ user.get_full_name|default:"Staff VGK" }}! üëã
            </h1>
            <p class="text-purple-100 text-lg">
                G√©rez les retraits, scannez les codes QR et assistez les clients depuis votre point de retrait.
            </p>
            <div class="flex items-center mt-4 space-x-4">
                <div class="flex items-center bg-white bg-opacity-20 rounded-lg px-3 py-1">
                    <i data-lucide="map-pin" class="w-4 h-4 mr-2"></i>
                    <span class="text-sm font-medium">{{ user.pickup_point.name|default:"Point de Retrait" }}</span>
                </div>
                <div class="flex items-center bg-white bg-opacity-20 rounded-lg px-3 py-1">
                    <i data-lucide="clock" class="w-4 h-4 mr-2"></i>
                    <span class="text-sm font-medium">Service actif</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions Section -->
    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6">
        <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-6">Actions Rapides</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
            <button class="flex flex-col items-center p-6 bg-gradient-to-br from-purple-500 to-purple-600 text-white rounded-xl hover:from-purple-600 hover:to-purple-700 transition-all duration-300 transform hover:scale-105" onclick="openQRScanner()">
                <i data-lucide="qr-code" class="w-8 h-8 mb-2"></i>
                <span class="text-sm font-medium">Scanner QR</span>
            </button>
            <button class="flex flex-col items-center p-6 bg-gradient-to-br from-green-500 to-green-600 text-white rounded-xl hover:from-green-600 hover:to-green-700 transition-all duration-300 transform hover:scale-105" onclick="openOrderSearch()">
                <i data-lucide="search" class="w-8 h-8 mb-2"></i>
                <span class="text-sm font-medium">Rechercher</span>
            </button>
            <button class="flex flex-col items-center p-6 bg-gradient-to-br from-blue-500 to-blue-600 text-white rounded-xl hover:from-blue-600 hover:to-blue-700 transition-all duration-300 transform hover:scale-105" onclick="openPickupForm()">
                <i data-lucide="package" class="w-8 h-8 mb-2"></i>
                <span class="text-sm font-medium">Retrait</span>
            </button>
            <a href="{% url 'backend:chat_list' %}" class="flex flex-col items-center p-6 bg-gradient-to-br from-orange-500 to-orange-600 text-white rounded-xl hover:from-orange-600 hover:to-orange-700 transition-all duration-300 transform hover:scale-105">
                <i data-lucide="message-circle" class="w-8 h-8 mb-2"></i>
                <span class="text-sm font-medium">Messages</span>
            </a>
        </div>
    </div>

    <!-- Stats Grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-6">
        <!-- Retraits Aujourd'hui -->
        <div class="stats-card">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-600 dark:text-gray-400 text-sm font-medium">Retraits Aujourd'hui</p>
                    <p class="text-3xl font-bold text-gray-900 dark:text-white">{{ todays_pickups|default:0 }}</p>
                    <p class="text-green-600 text-sm">
                        <i data-lucide="arrow-up" class="w-3 h-3 inline mr-1"></i>
                        {{ completed_pickups|default:0 }} compl√©t√©s
                    </p>
                </div>
                <div class="p-3 bg-purple-500 rounded-xl">
                    <i data-lucide="package-check" class="w-6 h-6 text-white"></i>
                </div>
            </div>
        </div>

        <!-- En Attente -->
        <div class="stats-card">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-600 dark:text-gray-400 text-sm font-medium">En Attente</p>
                    <p class="text-3xl font-bold text-gray-900 dark:text-white">{{ pending_pickups|default:0 }}</p>
                    <p class="text-orange-600 text-sm">
                        <i data-lucide="clock" class="w-3 h-3 inline mr-1"></i>
                        √Ä traiter
                    </p>
                </div>
                <div class="p-3 bg-orange-500 rounded-xl">
                    <i data-lucide="clock" class="w-6 h-6 text-white"></i>
                </div>
            </div>
        </div>

        <!-- Clients Aid√©s -->
        <div class="stats-card">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-600 dark:text-gray-400 text-sm font-medium">Clients Aid√©s</p>
                    <p class="text-3xl font-bold text-gray-900 dark:text-white">{{ clients_helped|default:0 }}</p>
                    <p class="text-blue-600 text-sm">
                        <i data-lucide="users" class="w-3 h-3 inline mr-1"></i>
                        Cette semaine
                    </p>
                </div>
                <div class="p-3 bg-blue-500 rounded-xl">
                    <i data-lucide="users" class="w-6 h-6 text-white"></i>
                </div>
            </div>
        </div>

        <!-- Messages -->
        <div class="stats-card">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-600 dark:text-gray-400 text-sm font-medium">Messages</p>
                    <p class="text-3xl font-bold text-gray-900 dark:text-white">{{ unread_messages|default:0 }}</p>
                    <p class="text-red-600 text-sm">
                        <i data-lucide="bell" class="w-3 h-3 inline mr-1"></i>
                        Non lus
                    </p>
                </div>
                <div class="p-3 bg-red-500 rounded-xl">
                    <i data-lucide="message-square" class="w-6 h-6 text-white"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Pickups -->
    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6">
        <div class="flex items-center justify-between mb-6">
            <h2 class="text-2xl font-bold text-gray-900 dark:text-white">Retraits R√©cents</h2>
            <a href="#" class="text-purple-600 hover:text-purple-700 font-medium flex items-center">
                Voir tout
                <i data-lucide="arrow-right" class="w-4 h-4 ml-1"></i>
            </a>
        </div>
        
        {% if recent_pickups %}
        <div class="space-y-4">
            {% for pickup in recent_pickups %}
            <div class="flex items-center justify-between p-4 bg-gray-50 dark:bg-gray-700 rounded-xl">
                <div class="flex items-center space-x-4">
                    <div class="p-2 {% if pickup.status == 'DELIVERED' %}bg-green-100 text-green-600{% elif pickup.status == 'SHIPPED' %}bg-blue-100 text-blue-600{% else %}bg-orange-100 text-orange-600{% endif %} rounded-lg">
                        <i data-lucide="{% if pickup.status == 'DELIVERED' %}check{% elif pickup.status == 'SHIPPED' %}truck{% else %}clock{% endif %}" class="w-5 h-5"></i>
                    </div>
                    <div>
                        <p class="font-medium text-gray-900 dark:text-white">Commande #{{ pickup.order_number }}</p>
                        <p class="text-sm text-gray-500 dark:text-gray-400">{{ pickup.product.title|truncatechars:50 }}</p>
                        <p class="text-sm text-gray-500 dark:text-gray-400">Code: {{ pickup.pickup_code }}</p>
                    </div>
                </div>
                <div class="text-right">
                    <p class="font-bold text-gray-900 dark:text-white">{{ pickup.total_amount|floatformat:2 }}‚Ç¨</p>
                    <p class="text-sm text-gray-500 dark:text-gray-400">{{ pickup.created_at|date:"d M √† H:i" }}</p>
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium
                        {% if pickup.status == 'DELIVERED' %}bg-green-100 text-green-800{% elif pickup.status == 'SHIPPED' %}bg-blue-100 text-blue-800{% else %}bg-orange-100 text-orange-800{% endif %}">
                        {{ pickup.get_status_display }}
                    </span>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="text-center py-12">
            <i data-lucide="package" class="w-16 h-16 text-gray-300 dark:text-gray-600 mx-auto mb-4"></i>
            <p class="text-gray-500 dark:text-gray-400 text-lg">Aucun retrait r√©cent</p>
            <p class="text-gray-400 dark:text-gray-500">Les retraits appara√Ætront ici</p>
        </div>
        {% endif %}
    </div>

    <!-- Performance Metrics -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Daily Performance -->
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6">
            <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-4">Performance Journali√®re</h3>
            <div class="space-y-4">
                <div class="flex items-center justify-between">
                    <span class="text-gray-600 dark:text-gray-400">Retraits trait√©s</span>
                    <span class="font-bold text-gray-900 dark:text-white">{{ todays_pickups|default:0 }}/{{ daily_target|default:20 }}</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2.5 dark:bg-gray-700">
                    <div class="bg-purple-600 h-2.5 rounded-full" style="width: {% widthratio todays_pickups daily_target|default:20 100 %}%"></div>
                </div>
                
                <div class="flex items-center justify-between">
                    <span class="text-gray-600 dark:text-gray-400">Satisfaction client</span>
                    <span class="font-bold text-green-600">{{ satisfaction_rate|default:95 }}%</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2.5 dark:bg-gray-700">
                    <div class="bg-green-600 h-2.5 rounded-full" style="width: {{ satisfaction_rate|default:95 }}%"></div>
                </div>
                
                <div class="flex items-center justify-between">
                    <span class="text-gray-600 dark:text-gray-400">Temps moyen/retrait</span>
                    <span class="font-bold text-blue-600">{{ avg_pickup_time|default:3 }}min</span>
                </div>
            </div>
        </div>

        <!-- Quick Stats -->
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6">
            <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-4">Statistiques Rapides</h3>
            <div class="grid grid-cols-2 gap-4">
                <div class="text-center p-4 bg-purple-50 dark:bg-purple-900/20 rounded-xl">
                    <p class="text-2xl font-bold text-purple-600">{{ weekly_pickups|default:0 }}</p>
                    <p class="text-sm text-gray-600 dark:text-gray-400">Cette semaine</p>
                </div>
                <div class="text-center p-4 bg-green-50 dark:bg-green-900/20 rounded-xl">
                    <p class="text-2xl font-bold text-green-600">{{ monthly_pickups|default:0 }}</p>
                    <p class="text-sm text-gray-600 dark:text-gray-400">Ce mois</p>
                </div>
                <div class="text-center p-4 bg-blue-50 dark:bg-blue-900/20 rounded-xl">
                    <p class="text-2xl font-bold text-blue-600">{{ total_clients|default:0 }}</p>
                    <p class="text-sm text-gray-600 dark:text-gray-400">Clients servis</p>
                </div>
                <div class="text-center p-4 bg-orange-50 dark:bg-orange-900/20 rounded-xl">
                    <p class="text-2xl font-bold text-orange-600">{{ efficiency_score|default:98 }}%</p>
                    <p class="text-sm text-gray-600 dark:text-gray-400">Efficacit√©</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- QR Scanner Modal -->
<div id="qr-scanner-modal" class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm z-50 hidden">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl max-w-md w-full p-6">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-bold text-gray-900 dark:text-white">Scanner QR Code</h3>
                <button class="text-gray-400 hover:text-gray-600" onclick="closeModal('qr-scanner-modal')">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            <div class="space-y-4">
                <div class="bg-gray-100 dark:bg-gray-700 rounded-xl p-8 text-center">
                    <i data-lucide="qr-code" class="w-16 h-16 text-gray-400 mx-auto mb-4"></i>
                    <p class="text-gray-600 dark:text-gray-300">Placez le QR code devant la cam√©ra</p>
                </div>
                <div class="flex space-x-3">
                    <button class="flex-1 bg-purple-600 text-white py-3 rounded-xl font-semibold hover:bg-purple-700 transition-colors">
                        D√©marrer scan
                    </button>
                    <button class="px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                        <i data-lucide="keyboard" class="w-5 h-5"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Order Search Modal -->
<div id="order-search-modal" class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm z-50 hidden">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl max-w-md w-full p-6">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-bold text-gray-900 dark:text-white">Rechercher Commande</h3>
                <button class="text-gray-400 hover:text-gray-600" onclick="closeModal('order-search-modal')">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            <form class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Num√©ro de commande</label>
                    <input type="text" class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent dark:bg-gray-700 dark:text-white" placeholder="VGK12345678">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Code de retrait</label>
                    <input type="text" class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent dark:bg-gray-700 dark:text-white" placeholder="123456">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">T√©l√©phone client</label>
                    <input type="tel" class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent dark:bg-gray-700 dark:text-white" placeholder="+237 6XX XXX XXX">
                </div>
                <button type="submit" class="w-full bg-purple-600 text-white py-3 rounded-xl font-semibold hover:bg-purple-700 transition-colors">
                    Rechercher
                </button>
            </form>
        </div>
    </div>
</div>

<!-- Pickup Form Modal -->
<div id="pickup-form-modal" class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm z-50 hidden">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl max-w-lg w-full p-6">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-bold text-gray-900 dark:text-white">Traiter Retrait</h3>
                <button class="text-gray-400 hover:text-gray-600" onclick="closeModal('pickup-form-modal')">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            <form class="space-y-4">
                <div class="bg-blue-50 dark:bg-blue-900/20 rounded-xl p-4">
                    <h4 class="font-semibold text-gray-900 dark:text-white mb-2">Informations Commande</h4>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span class="text-gray-600 dark:text-gray-400">Commande:</span>
                            <span class="font-medium">#VGK12345678</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600 dark:text-gray-400">Client:</span>
                            <span class="font-medium">Jean Dupont</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600 dark:text-gray-400">Produit:</span>
                            <span class="font-medium">iPhone 12 Pro</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600 dark:text-gray-400">Montant:</span>
                            <span class="font-medium text-green-600">350.000 FCFA</span>
                        </div>
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">V√©rification identit√©</label>
                    <div class="space-y-2">
                        <label class="flex items-center">
                            <input type="checkbox" class="rounded border-gray-300 text-purple-600 focus:ring-purple-500">
                            <span class="ml-2 text-sm text-gray-700 dark:text-gray-300">Pi√®ce d'identit√© v√©rifi√©e</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" class="rounded border-gray-300 text-purple-600 focus:ring-purple-500">
                            <span class="ml-2 text-sm text-gray-700 dark:text-gray-300">Code de retrait correct</span>
                        </label>
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">√âtat du produit</label>
                    <select class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent dark:bg-gray-700 dark:text-white">
                        <option value="perfect">Parfait √©tat</option>
                        <option value="good">Bon √©tat</option>
                        <option value="damaged">Endommag√©</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Notes (optionnel)</label>
                    <textarea class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent dark:bg-gray-700 dark:text-white" rows="3" placeholder="Notes sur le retrait..."></textarea>
                </div>
                
                <div class="flex space-x-3">
                    <button type="button" class="flex-1 bg-green-600 text-white py-3 rounded-xl font-semibold hover:bg-green-700 transition-colors">
                        Confirmer Retrait
                    </button>
                    <button type="button" class="px-6 py-3 border border-gray-300 dark:border-gray-600 rounded-xl hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                        Reporter
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function openModal(modalId) {
    document.getElementById(modalId).classList.remove('hidden');
}

function closeModal(modalId) {
    document.getElementById(modalId).classList.add('hidden');
}

function openQRScanner() {
    openModal('qr-scanner-modal');
}

function openOrderSearch() {
    openModal('order-search-modal');
}

function openPickupForm() {
    openModal('pickup-form-modal');
}

// Auto-refresh for real-time updates
setInterval(function() {
    // Refresh pending pickups count
    fetch('/staff/api/pending-count/')
        .then(response => response.json())
        .then(data => {
            // Update UI with new data
            console.log('Updated pending count:', data.count);
        })
        .catch(error => console.error('Error updating data:', error));
}, 30000); // Every 30 seconds
</script>
{% endblock %}