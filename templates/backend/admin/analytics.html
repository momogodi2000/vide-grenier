{% extends 'backend/base/admin_base.html' %}
{% load static %}
{% load humanize %}

{% block title %}Analytics Admin - Vidé-Grenier Kamer{% endblock %}

{% block content %}
<!-- Header -->
<div class="mb-8">
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between">
        <div class="mb-4 sm:mb-0">
            <h1 class="text-2xl sm:text-3xl font-bold text-gray-900 mb-2">Analytics & Rapports</h1>
            <p class="text-gray-600">Analyse détaillée des performances de la plateforme</p>
        </div>
        <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-3">
            <select class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                <option value="7">7 derniers jours</option>
                <option value="30" selected>30 derniers jours</option>
                <option value="90">90 derniers jours</option>
                <option value="365">1 an</option>
            </select>
            <button onclick="exportReport()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors flex items-center justify-center">
                <i data-lucide="download" class="w-4 h-4 mr-2"></i>
                Exporter Rapport
            </button>
            <button onclick="refreshAnalytics()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors flex items-center justify-center">
                <i data-lucide="refresh-cw" class="w-4 h-4 mr-2"></i>
                Actualiser
            </button>
        </div>
    </div>
</div>

<!-- Overview Cards -->
<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
    <div class="stats-card bg-gradient-to-br from-blue-500 to-blue-600 text-white">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-blue-100 text-sm font-medium">Revenus Totaux</p>
                <p class="text-2xl sm:text-3xl font-bold">{{ analytics.overview.total_revenue|floatformat:0|intcomma }} FCFA</p>
                <p class="text-blue-200 text-sm">+12.5% vs mois dernier</p>
            </div>
            <div class="p-3 bg-blue-400 bg-opacity-30 rounded-full">
                <i data-lucide="trending-up" class="w-6 h-6"></i>
            </div>
        </div>
    </div>

    <div class="stats-card bg-gradient-to-br from-green-500 to-green-600 text-white">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-green-100 text-sm font-medium">Commandes Totales</p>
                <p class="text-2xl sm:text-3xl font-bold">{{ analytics.overview.total_orders|intcomma }}</p>
                <p class="text-green-200 text-sm">+8.3% vs mois dernier</p>
            </div>
            <div class="p-3 bg-green-400 bg-opacity-30 rounded-full">
                <i data-lucide="shopping-cart" class="w-6 h-6"></i>
            </div>
        </div>
    </div>

    <div class="stats-card bg-gradient-to-br from-purple-500 to-purple-600 text-white">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-purple-100 text-sm font-medium">Utilisateurs Actifs</p>
                <p class="text-2xl sm:text-3xl font-bold">{{ analytics.user_analytics.active_users_week|intcomma }}</p>
                <p class="text-purple-200 text-sm">Cette semaine</p>
            </div>
            <div class="p-3 bg-purple-400 bg-opacity-30 rounded-full">
                <i data-lucide="users" class="w-6 h-6"></i>
            </div>
        </div>
    </div>

    <div class="stats-card bg-gradient-to-br from-orange-500 to-orange-600 text-white">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-orange-100 text-sm font-medium">Taux de Conversion</p>
                <p class="text-2xl sm:text-3xl font-bold">{{ analytics.overview.conversion_rate|floatformat:1 }}%</p>
                <p class="text-orange-200 text-sm">+2.1% vs mois dernier</p>
            </div>
            <div class="p-3 bg-orange-400 bg-opacity-30 rounded-full">
                <i data-lucide="target" class="w-6 h-6"></i>
            </div>
        </div>
    </div>
</div>

<!-- Charts Section -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
    <!-- Revenue Chart -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
        <div class="flex items-center justify-between mb-6">
            <h3 class="text-lg font-semibold text-gray-900">Évolution des Revenus</h3>
            <div class="flex items-center space-x-2">
                <span class="w-3 h-3 bg-blue-500 rounded-full"></span>
                <span class="text-sm text-gray-600">Revenus (FCFA)</span>
            </div>
        </div>
        <div class="h-64 flex items-center justify-center">
            <canvas id="revenueChart" width="400" height="200"></canvas>
        </div>
    </div>

    <!-- Users Chart -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
        <div class="flex items-center justify-between mb-6">
            <h3 class="text-lg font-semibold text-gray-900">Nouveaux Utilisateurs</h3>
            <div class="flex items-center space-x-2">
                <span class="w-3 h-3 bg-green-500 rounded-full"></span>
                <span class="text-sm text-gray-600">Utilisateurs</span>
            </div>
        </div>
        <div class="h-64 flex items-center justify-center">
            <canvas id="usersChart" width="400" height="200"></canvas>
        </div>
    </div>
</div>

<!-- Detailed Analytics -->
<div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
    <!-- User Analytics -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-6">Analyse des Utilisateurs</h3>
        
        <div class="space-y-4">
            <div class="flex justify-between items-center">
                <span class="text-sm text-gray-600">Nouveaux aujourd'hui</span>
                <span class="font-semibold text-blue-600">{{ analytics.user_analytics.new_users_today }}</span>
            </div>
            <div class="flex justify-between items-center">
                <span class="text-sm text-gray-600">Nouveaux cette semaine</span>
                <span class="font-semibold text-green-600">{{ analytics.user_analytics.new_users_week }}</span>
            </div>
            <div class="flex justify-between items-center">
                <span class="text-sm text-gray-600">Nouveaux ce mois</span>
                <span class="font-semibold text-purple-600">{{ analytics.user_analytics.new_users_month }}</span>
            </div>
        </div>

        <div class="mt-6 pt-6 border-t border-gray-200">
            <h4 class="text-md font-medium text-gray-900 mb-4">Répartition par Type</h4>
            <div class="space-y-3">
                <div class="flex justify-between items-center">
                    <span class="text-sm text-gray-600">Clients</span>
                    <span class="px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded-full">{{ analytics.user_analytics.user_types.clients }}</span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-sm text-gray-600">Vendeurs</span>
                    <span class="px-2 py-1 bg-green-100 text-green-800 text-xs rounded-full">{{ analytics.user_analytics.user_types.sellers }}</span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-sm text-gray-600">Staff</span>
                    <span class="px-2 py-1 bg-purple-100 text-purple-800 text-xs rounded-full">{{ analytics.user_analytics.user_types.staff }}</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Product Analytics -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-6">Analyse des Produits</h3>
        
        <div class="space-y-4">
            <div class="flex justify-between items-center">
                <span class="text-sm text-gray-600">Produits aujourd'hui</span>
                <span class="font-semibold text-blue-600">{{ analytics.product_analytics.products_today }}</span>
            </div>
            <div class="flex justify-between items-center">
                <span class="text-sm text-gray-600">Produits cette semaine</span>
                <span class="font-semibold text-green-600">{{ analytics.product_analytics.products_week }}</span>
            </div>
            <div class="flex justify-between items-center">
                <span class="text-sm text-gray-600">Prix moyen</span>
                <span class="font-semibold text-purple-600">{{ analytics.product_analytics.avg_product_price|floatformat:0 }} FCFA</span>
            </div>
        </div>

        <div class="mt-6 pt-6 border-t border-gray-200">
            <h4 class="text-md font-medium text-gray-900 mb-4">Top Catégories</h4>
            <div class="space-y-3">
                {% for category in analytics.product_analytics.top_categories %}
                <div class="flex justify-between items-center">
                    <span class="text-sm text-gray-600">{{ category.name }}</span>
                    <span class="px-2 py-1 bg-gray-100 text-gray-800 text-xs rounded-full">{{ category.product_count }}</span>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Sales Analytics -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-6">Analyse des Ventes</h3>
        
        <div class="space-y-4">
            <div class="flex justify-between items-center">
                <span class="text-sm text-gray-600">Revenus aujourd'hui</span>
                <span class="font-semibold text-blue-600">{{ analytics.sales_analytics.revenue_today|floatformat:0 }} FCFA</span>
            </div>
            <div class="flex justify-between items-center">
                <span class="text-sm text-gray-600">Revenus cette semaine</span>
                <span class="font-semibold text-green-600">{{ analytics.sales_analytics.revenue_week|floatformat:0 }} FCFA</span>
            </div>
            <div class="flex justify-between items-center">
                <span class="text-sm text-gray-600">Panier moyen</span>
                <span class="font-semibold text-purple-600">{{ analytics.sales_analytics.avg_order_value|floatformat:0 }} FCFA</span>
            </div>
        </div>

        <div class="mt-6 pt-6 border-t border-gray-200">
            <h4 class="text-md font-medium text-gray-900 mb-4">Statuts des Commandes</h4>
            <div class="space-y-3">
                <div class="flex justify-between items-center">
                    <span class="text-sm text-gray-600">En attente</span>
                    <span class="px-2 py-1 bg-yellow-100 text-yellow-800 text-xs rounded-full">{{ analytics.sales_analytics.order_statuses.pending }}</span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-sm text-gray-600">Confirmées</span>
                    <span class="px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded-full">{{ analytics.sales_analytics.order_statuses.confirmed }}</span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-sm text-gray-600">Livrées</span>
                    <span class="px-2 py-1 bg-green-100 text-green-800 text-xs rounded-full">{{ analytics.sales_analytics.order_statuses.delivered }}</span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-sm text-gray-600">Annulées</span>
                    <span class="px-2 py-1 bg-red-100 text-red-800 text-xs rounded-full">{{ analytics.sales_analytics.order_statuses.cancelled }}</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Engagement & Newsletter Analytics -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
    <!-- Engagement Analytics -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-6">Engagement Utilisateurs</h3>
        
        <div class="grid grid-cols-2 gap-4 mb-6">
            <div class="text-center p-4 bg-blue-50 rounded-lg">
                <div class="text-2xl font-bold text-blue-600">{{ analytics.engagement_analytics.total_reviews|intcomma }}</div>
                <div class="text-sm text-blue-800">Total Avis</div>
            </div>
            <div class="text-center p-4 bg-green-50 rounded-lg">
                <div class="text-2xl font-bold text-green-600">{{ analytics.engagement_analytics.avg_rating|floatformat:1 }}/5</div>
                <div class="text-sm text-green-800">Note Moyenne</div>
            </div>
        </div>
        
        <div class="space-y-4">
            <div class="flex justify-between items-center">
                <span class="text-sm text-gray-600">Avis cette semaine</span>
                <span class="font-semibold text-blue-600">{{ analytics.engagement_analytics.reviews_week }}</span>
            </div>
            <div class="flex justify-between items-center">
                <span class="text-sm text-gray-600">Chats actifs</span>
                <span class="font-semibold text-green-600">{{ analytics.engagement_analytics.active_chats }}</span>
            </div>
            <div class="flex justify-between items-center">
                <span class="text-sm text-gray-600">Messages cette semaine</span>
                <span class="font-semibold text-purple-600">{{ analytics.engagement_analytics.messages_week }}</span>
            </div>
        </div>

        <div class="mt-6 pt-6 border-t border-gray-200">
            <h4 class="text-md font-medium text-gray-900 mb-4">Fidélité Clients</h4>
            <div class="space-y-3">
                <div class="flex justify-between items-center">
                    <span class="text-sm text-gray-600">Bronze</span>
                    <span class="px-2 py-1 bg-orange-100 text-orange-800 text-xs rounded-full">{{ analytics.user_analytics.loyalty_levels.bronze }}</span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-sm text-gray-600">Argent</span>
                    <span class="px-2 py-1 bg-gray-100 text-gray-800 text-xs rounded-full">{{ analytics.user_analytics.loyalty_levels.silver }}</span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-sm text-gray-600">Or</span>
                    <span class="px-2 py-1 bg-yellow-100 text-yellow-800 text-xs rounded-full">{{ analytics.user_analytics.loyalty_levels.gold }}</span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-sm text-gray-600">Platine</span>
                    <span class="px-2 py-1 bg-purple-100 text-purple-800 text-xs rounded-full">{{ analytics.user_analytics.loyalty_levels.platinum }}</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Newsletter Analytics -->
    {% if analytics.newsletter_analytics %}
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-6">Newsletter & Communications</h3>
        
        <div class="grid grid-cols-2 gap-4 mb-6">
            <div class="text-center p-4 bg-indigo-50 rounded-lg">
                <div class="text-2xl font-bold text-indigo-600">{{ analytics.newsletter_analytics.total_subscribers|intcomma }}</div>
                <div class="text-sm text-indigo-800">Abonnés Actifs</div>
            </div>
            <div class="text-center p-4 bg-pink-50 rounded-lg">
                <div class="text-2xl font-bold text-pink-600">{{ analytics.newsletter_analytics.sent_newsletters }}</div>
                <div class="text-sm text-pink-800">Envois Total</div>
            </div>
        </div>
        
        <div class="space-y-4">
            <div class="flex justify-between items-center">
                <span class="text-sm text-gray-600">Nouveaux abonnés (semaine)</span>
                <span class="font-semibold text-green-600">+{{ analytics.newsletter_analytics.subscribers_week }}</span>
            </div>
            <div class="flex justify-between items-center">
                <span class="text-sm text-gray-600">Newsletters en brouillon</span>
                <span class="font-semibold text-orange-600">{{ analytics.newsletter_analytics.total_newsletters|add:"-"|add:analytics.newsletter_analytics.sent_newsletters }}</span>
            </div>
        </div>

        <div class="mt-6">
            <a href="{% url 'backend:admin_newsletter_list' %}" class="w-full bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition-colors flex items-center justify-center">
                <i data-lucide="mail" class="w-4 h-4 mr-2"></i>
                Gérer Newsletter
            </a>
        </div>
    </div>
    {% endif %}
</div>

<!-- Performance Insights -->
<div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-8">
    <h3 class="text-lg font-semibold text-gray-900 mb-6">Insights & Recommandations</h3>
    
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        <!-- Performance Insight -->
        <div class="p-4 bg-green-50 border border-green-200 rounded-lg">
            <div class="flex items-center mb-3">
                <div class="p-2 bg-green-100 rounded-full mr-3">
                    <i data-lucide="trending-up" class="w-5 h-5 text-green-600"></i>
                </div>
                <h4 class="font-semibold text-green-800">Performance Excellente</h4>
            </div>
            <p class="text-sm text-green-700">Les ventes ont augmenté de 12.5% ce mois. Continuez sur cette lancée!</p>
        </div>

        <!-- Warning Insight -->
        <div class="p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
            <div class="flex items-center mb-3">
                <div class="p-2 bg-yellow-100 rounded-full mr-3">
                    <i data-lucide="alert-triangle" class="w-5 h-5 text-yellow-600"></i>
                </div>
                <h4 class="font-semibold text-yellow-800">Attention Requise</h4>
            </div>
            <p class="text-sm text-yellow-700">{{ analytics.product_analytics.pending_moderation }} produits en attente de modération.</p>
        </div>

        <!-- Action Insight -->
        <div class="p-4 bg-blue-50 border border-blue-200 rounded-lg">
            <div class="flex items-center mb-3">
                <div class="p-2 bg-blue-100 rounded-full mr-3">
                    <i data-lucide="lightbulb" class="w-5 h-5 text-blue-600"></i>
                </div>
                <h4 class="font-semibold text-blue-800">Opportunité</h4>
            </div>
            <p class="text-sm text-blue-700">Promouvoir les catégories populaires pour augmenter les ventes.</p>
        </div>
    </div>
</div>

<!-- Monthly Trends Table -->
<div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
    <div class="p-6 border-b border-gray-200">
        <h3 class="text-lg font-semibold text-gray-900">Évolution Mensuelle</h3>
    </div>
    
    <div class="overflow-x-auto">
        <table class="w-full">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Mois</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Utilisateurs</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Produits</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Commandes</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Revenus (FCFA)</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                {% for month_data in analytics.monthly_data %}
                <tr class="hover:bg-gray-50 transition-colors">
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                        {{ month_data.month }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        {{ month_data.users|intcomma }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        {{ month_data.products|intcomma }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        {{ month_data.orders|intcomma }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        {{ month_data.revenue|floatformat:0|intcomma }}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
// Chart.js Configuration
document.addEventListener('DOMContentLoaded', function() {
    // Revenue Chart
    const revenueCtx = document.getElementById('revenueChart').getContext('2d');
    new Chart(revenueCtx, {
        type: 'line',
        data: {
            labels: [{% for month in analytics.monthly_data %}'{{ month.month }}'{% if not forloop.last %},{% endif %}{% endfor %}],
            datasets: [{
                label: 'Revenus (FCFA)',
                data: [{% for month in analytics.monthly_data %}{{ month.revenue|default:0 }}{% if not forloop.last %},{% endif %}{% endfor %}],
                borderColor: 'rgb(59, 130, 246)',
                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return value.toLocaleString() + ' FCFA';
                        }
                    }
                }
            }
        }
    });

    // Users Chart
    const usersCtx = document.getElementById('usersChart').getContext('2d');
    new Chart(usersCtx, {
        type: 'bar',
        data: {
            labels: [{% for month in analytics.monthly_data %}'{{ month.month }}'{% if not forloop.last %},{% endif %}{% endfor %}],
            datasets: [{
                label: 'Nouveaux Utilisateurs',
                data: [{% for month in analytics.monthly_data %}{{ month.users|default:0 }}{% if not forloop.last %},{% endif %}{% endfor %}],
                backgroundColor: 'rgba(34, 197, 94, 0.8)',
                borderColor: 'rgb(34, 197, 94)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
});

// Utility Functions
function exportReport() {
    const exportType = document.querySelector('select').value;
    window.location.href = `{% url 'backend:admin_export_data' 'analytics' %}?period=${exportType}`;
}

function refreshAnalytics() {
    fetch('{% url "backend:admin_stats_ajax" %}')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            }
        })
        .catch(error => {
            console.error('Error refreshing analytics:', error);
        });
}

// Initialize Lucide icons
if (typeof lucide !== 'undefined') {
    lucide.createIcons();
}
</script>

<!-- Chart.js CDN -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
{% endblock %}