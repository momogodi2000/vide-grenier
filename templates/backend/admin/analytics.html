{% extends 'backend/base/admin_base.html' %}
{% load static %}
{% load humanize %}

{% block title %}Analytics Dashboard - Admin VGK{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header -->
    <div class="bg-white dark:bg-gray-800 shadow-xl rounded-2xl p-6 border border-gray-200 dark:border-gray-700">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-3xl font-bold text-gray-900 dark:text-white">Analytics Dashboard</h1>
                <p class="text-gray-500 dark:text-gray-400 mt-1">Vue d'ensemble des performances de la plateforme</p>
            </div>
            <div class="flex items-center space-x-3">
                <button onclick="refreshData()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-xl font-medium transition-colors">
                    <i data-lucide="refresh-cw" class="w-4 h-4 mr-2 inline"></i>
                    Actualiser
                </button>
                <button onclick="exportData()" class="px-4 py-2 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 rounded-xl font-medium hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                    <i data-lucide="download" class="w-4 h-4 mr-2 inline"></i>
                    Exporter
                </button>
            </div>
        </div>
    </div>

    <!-- Key Metrics -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        <div class="metric-card bg-gradient-to-br from-blue-500 to-blue-600">
            <div class="absolute -top-4 -right-4 w-20 h-20 bg-white/10 rounded-full"></div>
            <div class="relative z-10">
                <div class="flex items-center justify-between mb-2">
                    <i data-lucide="users" class="w-8 h-8 text-white/80"></i>
                    <span class="text-2xl font-bold text-white">{{ overview_stats.total_users|default:0|intcomma }}</span>
                </div>
                <p class="text-white/90 font-medium">Utilisateurs Total</p>
                <div class="mt-2 flex items-center text-white/70 text-sm">
                    <i data-lucide="trending-up" class="w-4 h-4 mr-1"></i>
                    +{{ overview_stats.active_users_week|default:0 }} cette semaine
                </div>
            </div>
        </div>

        <div class="metric-card bg-gradient-to-br from-green-500 to-green-600">
            <div class="absolute -top-4 -right-4 w-20 h-20 bg-white/10 rounded-full"></div>
            <div class="relative z-10">
                <div class="flex items-center justify-between mb-2">
                    <i data-lucide="package" class="w-8 h-8 text-white/80"></i>
                    <span class="text-2xl font-bold text-white">{{ overview_stats.total_products|default:0|intcomma }}</span>
                </div>
                <p class="text-white/90 font-medium">Produits</p>
                <div class="mt-2 flex items-center text-white/70 text-sm">
                    <i data-lucide="check-circle" class="w-4 h-4 mr-1"></i>
                    {{ overview_stats.active_products|default:0 }} actifs
                </div>
            </div>
        </div>

        <div class="metric-card bg-gradient-to-br from-purple-500 to-purple-600">
            <div class="absolute -top-4 -right-4 w-20 h-20 bg-white/10 rounded-full"></div>
            <div class="relative z-10">
                <div class="flex items-center justify-between mb-2">
                    <i data-lucide="shopping-cart" class="w-8 h-8 text-white/80"></i>
                    <span class="text-2xl font-bold text-white">{{ overview_stats.total_orders|default:0|intcomma }}</span>
                </div>
                <p class="text-white/90 font-medium">Commandes</p>
                <div class="mt-2 flex items-center text-white/70 text-sm">
                    <i data-lucide="calendar" class="w-4 h-4 mr-1"></i>
                    {{ overview_stats.orders_this_month|default:0 }} ce mois
                </div>
            </div>
        </div>

        <div class="metric-card bg-gradient-to-br from-yellow-500 to-orange-500">
            <div class="absolute -top-4 -right-4 w-20 h-20 bg-white/10 rounded-full"></div>
            <div class="relative z-10">
                <div class="flex items-center justify-between mb-2">
                    <i data-lucide="banknote" class="w-8 h-8 text-white/80"></i>
                    <span class="text-2xl font-bold text-white">{{ overview_stats.total_revenue|default:0|floatformat:0|intcomma }}</span>
                </div>
                <p class="text-white/90 font-medium">Revenus (FCFA)</p>
                <div class="mt-2 flex items-center text-white/70 text-sm">
                    <i data-lucide="percent" class="w-4 h-4 mr-1"></i>
                    {{ overview_stats.commission_earned|default:0|floatformat:0|intcomma }} commission
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Row -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Revenue Chart -->
        <div class="bg-white dark:bg-gray-800 shadow-xl rounded-2xl p-6 border border-gray-200 dark:border-gray-700">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-xl font-semibold text-gray-900 dark:text-white">
                    <i data-lucide="trending-up" class="w-5 h-5 mr-2 inline text-blue-500"></i>
                    Évolution des Revenus
                </h2>
                <select id="revenueTimeframe" class="px-3 py-1 border border-gray-300 dark:border-gray-600 rounded-lg text-sm dark:bg-gray-700 dark:text-white">
                    <option value="7">7 derniers jours</option>
                    <option value="30" selected>30 derniers jours</option>
                    <option value="90">3 derniers mois</option>
                </select>
            </div>
            <div class="h-80">
                <canvas id="revenueChart" class="w-full h-full"></canvas>
            </div>
        </div>

        <!-- User Growth Chart -->
        <div class="bg-white dark:bg-gray-800 shadow-xl rounded-2xl p-6 border border-gray-200 dark:border-gray-700">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-xl font-semibold text-gray-900 dark:text-white">
                    <i data-lucide="users" class="w-5 h-5 mr-2 inline text-green-500"></i>
                    Croissance Utilisateurs
                </h2>
                <div class="text-sm text-gray-500 dark:text-gray-400">12 derniers mois</div>
            </div>
            <div class="h-80">
                <canvas id="userChart" class="w-full h-full"></canvas>
            </div>
        </div>
    </div>

    <!-- Statistics Tables -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Top Categories -->
        <div class="bg-white dark:bg-gray-800 shadow-xl rounded-2xl border border-gray-200 dark:border-gray-700">
            <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                <h2 class="text-xl font-semibold text-gray-900 dark:text-white">
                    <i data-lucide="layers" class="w-5 h-5 mr-2 inline text-purple-500"></i>
                    Top Catégories
                </h2>
            </div>
            <div class="p-6">
                {% for category in top_categories|slice:":5" %}
                <div class="flex items-center justify-between py-3 {% if not forloop.last %}border-b border-gray-100 dark:border-gray-700{% endif %}">
                    <div>
                        <p class="font-medium text-gray-900 dark:text-white">{{ category.name }}</p>
                        <p class="text-sm text-gray-500 dark:text-gray-400">{{ category.product_count }} produits</p>
                    </div>
                    <div class="text-right">
                        <p class="font-semibold text-green-600">{{ category.sales_count }}</p>
                        <p class="text-xs text-gray-500 dark:text-gray-400">ventes</p>
                    </div>
                </div>
                {% empty %}
                <p class="text-gray-500 dark:text-gray-400 text-center py-4">Aucune donnée disponible</p>
                {% endfor %}
            </div>
        </div>

        <!-- City Distribution -->
        <div class="bg-white dark:bg-gray-800 shadow-xl rounded-2xl border border-gray-200 dark:border-gray-700">
            <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                <h2 class="text-xl font-semibold text-gray-900 dark:text-white">
                    <i data-lucide="map-pin" class="w-5 h-5 mr-2 inline text-red-500"></i>
                    Répartition par Ville
                </h2>
            </div>
            <div class="p-6">
                {% for city in city_distribution|slice:":5" %}
                <div class="flex items-center justify-between py-3 {% if not forloop.last %}border-b border-gray-100 dark:border-gray-700{% endif %}">
                    <div>
                        <p class="font-medium text-gray-900 dark:text-white">{{ city.name }}</p>
                        <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2 mt-1">
                            <div class="bg-blue-500 h-2 rounded-full" style="width: {{ city.percentage }}%"></div>
                        </div>
                    </div>
                    <div class="text-right ml-4">
                        <p class="font-semibold text-blue-600">{{ city.users }}</p>
                        <p class="text-xs text-gray-500 dark:text-gray-400">{{ city.percentage }}%</p>
                    </div>
                </div>
                {% empty %}
                <p class="text-gray-500 dark:text-gray-400 text-center py-4">Aucune donnée disponible</p>
                {% endfor %}
            </div>
        </div>

        <!-- Recent Activity -->
        <div class="bg-white dark:bg-gray-800 shadow-xl rounded-2xl border border-gray-200 dark:border-gray-700">
            <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                <h2 class="text-xl font-semibold text-gray-900 dark:text-white">
                    <i data-lucide="activity" class="w-5 h-5 mr-2 inline text-orange-500"></i>
                    Activité Récente
                </h2>
            </div>
            <div class="p-6">
                <div class="space-y-4">
                    <div class="flex items-center">
                        <div class="w-2 h-2 bg-green-500 rounded-full mr-3"></div>
                        <div class="flex-1">
                            <p class="text-sm font-medium text-gray-900 dark:text-white">Nouveau produit ajouté</p>
                            <p class="text-xs text-gray-500 dark:text-gray-400">Il y a 2 minutes</p>
                        </div>
                    </div>
                    <div class="flex items-center">
                        <div class="w-2 h-2 bg-blue-500 rounded-full mr-3"></div>
                        <div class="flex-1">
                            <p class="text-sm font-medium text-gray-900 dark:text-white">Nouvel utilisateur inscrit</p>
                            <p class="text-xs text-gray-500 dark:text-gray-400">Il y a 5 minutes</p>
                        </div>
                    </div>
                    <div class="flex items-center">
                        <div class="w-2 h-2 bg-purple-500 rounded-full mr-3"></div>
                        <div class="flex-1">
                            <p class="text-sm font-medium text-gray-900 dark:text-white">Commande complétée</p>
                            <p class="text-xs text-gray-500 dark:text-gray-400">Il y a 8 minutes</p>
                        </div>
                    </div>
                    <div class="flex items-center">
                        <div class="w-2 h-2 bg-yellow-500 rounded-full mr-3"></div>
                        <div class="flex-1">
                            <p class="text-sm font-medium text-gray-900 dark:text-white">Produit en attente</p>
                            <p class="text-xs text-gray-500 dark:text-gray-400">Il y a 12 minutes</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Performance Summary -->
    <div class="bg-white dark:bg-gray-800 shadow-xl rounded-2xl p-6 border border-gray-200 dark:border-gray-700">
        <h2 class="text-xl font-semibold text-gray-900 dark:text-white mb-6">
            <i data-lucide="bar-chart-3" class="w-5 h-5 mr-2 inline text-indigo-500"></i>
            Résumé des Performances
        </h2>
        
        <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-6 gap-6">
            <div class="text-center">
                <div class="text-2xl font-bold text-gray-900 dark:text-white">85%</div>
                <div class="text-sm text-gray-500 dark:text-gray-400">Taux de satisfaction</div>
            </div>
            <div class="text-center">
                <div class="text-2xl font-bold text-gray-900 dark:text-white">42</div>
                <div class="text-sm text-gray-500 dark:text-gray-400">Temps session (min)</div>
            </div>
            <div class="text-center">
                <div class="text-2xl font-bold text-gray-900 dark:text-white">2.8</div>
                <div class="text-sm text-gray-500 dark:text-gray-400">Pages par session</div>
            </div>
            <div class="text-center">
                <div class="text-2xl font-bold text-gray-900 dark:text-white">68%</div>
                <div class="text-sm text-gray-500 dark:text-gray-400">Taux de conversion</div>
            </div>
            <div class="text-center">
                <div class="text-2xl font-bold text-gray-900 dark:text-white">1.2s</div>
                <div class="text-sm text-gray-500 dark:text-gray-400">Temps de chargement</div>
            </div>
            <div class="text-center">
                <div class="text-2xl font-bold text-gray-900 dark:text-white">96%</div>
                <div class="text-sm text-gray-500 dark:text-gray-400">Disponibilité</div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Revenue Chart
    const revenueCtx = document.getElementById('revenueChart').getContext('2d');
    const revenueChart = new Chart(revenueCtx, {
        type: 'line',
        data: {
            labels: [
                {% for trend in revenue_trends|slice:":30" %}
                '{{ trend.date|date:"d/m" }}'{% if not forloop.last %},{% endif %}
                {% endfor %}
            ],
            datasets: [{
                label: 'Revenus (FCFA)',
                data: [
                    {% for trend in revenue_trends|slice:":30" %}
                    {{ trend.revenue }}{% if not forloop.last %},{% endif %}
                    {% endfor %}
                ],
                borderColor: 'rgb(59, 130, 246)',
                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                borderWidth: 3,
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return value.toLocaleString('fr-FR') + ' FCFA';
                        }
                    }
                }
            }
        }
    });

    // User Growth Chart
    const userCtx = document.getElementById('userChart').getContext('2d');
    const userChart = new Chart(userCtx, {
        type: 'bar',
        data: {
            labels: [
                {% for data in monthly_charts_data|slice:":12" %}
                '{{ data.month }}'{% if not forloop.last %},{% endif %}
                {% endfor %}
            ],
            datasets: [{
                label: 'Nouveaux utilisateurs',
                data: [
                    {% for data in monthly_charts_data|slice:":12" %}
                    {{ data.users }}{% if not forloop.last %},{% endif %}
                    {% endfor %}
                ],
                backgroundColor: 'rgba(34, 197, 94, 0.8)',
                borderColor: 'rgb(34, 197, 94)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });

    // Initialize Lucide icons
    if (typeof lucide !== 'undefined') {
        lucide.createIcons();
    }
});

function refreshData() {
    // Show loading state
    const refreshBtn = document.querySelector('button[onclick="refreshData()"]');
    const originalText = refreshBtn.innerHTML;
    refreshBtn.innerHTML = '<i data-lucide="loader-2" class="w-4 h-4 mr-2 inline animate-spin"></i>Actualisation...';
    
    // Simulate refresh (in real app, make AJAX call)
    setTimeout(() => {
        refreshBtn.innerHTML = originalText;
        lucide.createIcons();
        location.reload();
    }, 2000);
}

function exportData() {
    // Export functionality
    alert('Fonctionnalité d\'export en cours de développement');
}
</script>
{% endblock %}