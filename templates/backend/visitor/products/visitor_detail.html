{% extends 'backend/visitor/base.html' %}
{% load static %}
{% load humanize %}

{% block title %}{{ product.title }} - Vidé-Grenier Kamer{% endblock %}

{% block extra_css %}
<style>
    .product-gallery {
        position: relative;
        overflow: hidden;
        border-radius: 16px;
        background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
    }
    
    .product-image {
        transition: transform 0.3s ease;
        cursor: pointer;
    }
    
    .product-image:hover {
        transform: scale(1.05);
    }
    
    .thumbnail {
        transition: all 0.3s ease;
        border: 2px solid transparent;
        cursor: pointer;
    }
    
    .thumbnail:hover {
        border-color: #3b82f6;
        transform: scale(1.1);
    }
    
    .thumbnail.active {
        border-color: #3b82f6;
        box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
    }
    
    .price-badge {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
        padding: 8px 16px;
        border-radius: 20px;
        font-weight: bold;
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
    }
    
    .condition-badge {
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
    }
    
    .condition-neuf { background: #dcfce7; color: #166534; }
    .condition-excellent { background: #dbeafe; color: #1e40af; }
    .condition-bon { background: #fef3c7; color: #92400e; }
    .condition-correct { background: #f3e8ff; color: #7c3aed; }
    .condition-usage { background: #fee2e2; color: #991b1b; }
    
    .action-button {
        transition: all 0.3s ease;
        border-radius: 12px;
        font-weight: 600;
        padding: 12px 24px;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        text-decoration: none;
        border: none;
        cursor: pointer;
    }
    
    .action-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }
    
    .btn-primary {
        background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
        color: white;
    }
    
    .btn-secondary {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
    }
    
    .btn-outline {
        background: transparent;
        border: 2px solid #3b82f6;
        color: #3b82f6;
    }
    
    .btn-outline:hover {
        background: #3b82f6;
        color: white;
    }
    
    .seller-card {
        background: linear-gradient(135deg, rgba(255,255,255,0.9) 0%, rgba(255,255,255,0.7) 100%);
        border: 1px solid #e5e7eb;
        border-radius: 16px;
        backdrop-filter: blur(10px);
    }
    
    .similar-product {
        transition: all 0.3s ease;
        border-radius: 12px;
        overflow: hidden;
        background: white;
        border: 1px solid #e5e7eb;
    }
    
    .similar-product:hover {
        transform: translateY(-4px);
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        border-color: #3b82f6;
    }
    
    .quantity-input {
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        padding: 8px 12px;
        text-align: center;
        font-weight: 600;
        transition: border-color 0.3s ease;
    }
    
    .quantity-input:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    
    .quantity-btn {
        width: 40px;
        height: 40px;
        border: 2px solid #e5e7eb;
        background: white;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: bold;
    }
    
    .quantity-btn:hover {
        border-color: #3b82f6;
        background: #3b82f6;
        color: white;
    }
    
    .quantity-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    
    .whatsapp-button {
        background: linear-gradient(135deg, #25d366 0%, #128c7e 100%);
        color: white;
        border: none;
        border-radius: 12px;
        padding: 12px 24px;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        text-decoration: none;
        transition: all 0.3s ease;
    }
    
    .whatsapp-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(37, 211, 102, 0.3);
        color: white;
    }
    
    .cart-success {
        position: fixed;
        top: 20px;
        right: 20px;
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
        padding: 16px 24px;
        border-radius: 12px;
        box-shadow: 0 10px 25px rgba(16, 185, 129, 0.3);
        z-index: 1000;
        transform: translateX(400px);
        transition: transform 0.3s ease;
    }
    
    .cart-success.show {
        transform: translateX(0);
    }
    
    .loading-spinner {
        border: 2px solid #f3f4f6;
        border-top: 2px solid #3b82f6;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Breadcrumb -->
    <nav class="flex mb-8" aria-label="Breadcrumb">
        <ol class="inline-flex items-center space-x-1 md:space-x-3">
            <li class="inline-flex items-center">
                <a href="{% url 'backend:visitor_product_list' %}" class="inline-flex items-center text-sm font-medium text-gray-700 hover:text-blue-600 dark:text-gray-400 dark:hover:text-white">
                    <i data-lucide="home" class="w-4 h-4 mr-2"></i>
                    Produits
                </a>
            </li>
            <li>
                <div class="flex items-center">
                    <i data-lucide="chevron-right" class="w-4 h-4 text-gray-400"></i>
                    <a href="{% url 'backend:category_detail' product.category.slug %}" class="ml-1 text-sm font-medium text-gray-700 hover:text-blue-600 md:ml-2 dark:text-gray-400 dark:hover:text-white">
                        {{ product.category.name }}
                    </a>
                </div>
            </li>
            <li aria-current="page">
                <div class="flex items-center">
                    <i data-lucide="chevron-right" class="w-4 h-4 text-gray-400"></i>
                    <span class="ml-1 text-sm font-medium text-gray-500 md:ml-2 dark:text-gray-400">
                        {{ product.title|truncatechars:30 }}
                    </span>
                </div>
            </li>
        </ol>
    </nav>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <!-- Product Images -->
        <div class="space-y-4">
            <div class="product-gallery">
                <img id="main-image" src="{{ product.main_image.image.url|default:'/static/backend/images/placeholder.jpg' }}" 
                     alt="{{ product.title }}" 
                     class="w-full h-96 object-cover product-image">
                
                <!-- Image Navigation -->
                <div class="absolute top-4 right-4 flex space-x-2">
                    <button onclick="previousImage()" class="bg-white/80 backdrop-blur-sm p-2 rounded-full shadow-lg hover:bg-white transition-all">
                        <i data-lucide="chevron-left" class="w-5 h-5"></i>
                    </button>
                    <button onclick="nextImage()" class="bg-white/80 backdrop-blur-sm p-2 rounded-full shadow-lg hover:bg-white transition-all">
                        <i data-lucide="chevron-right" class="w-5 h-5"></i>
                    </button>
                </div>
            </div>
            
            <!-- Thumbnails -->
            {% if product.images.count > 1 %}
            <div class="flex space-x-2 overflow-x-auto pb-2">
                {% for image in product.images.all %}
                <img src="{{ image.image.url }}" 
                     alt="{{ product.title }}" 
                     onclick="changeMainImage('{{ image.image.url }}', this)"
                     class="thumbnail w-20 h-20 object-cover rounded-lg cursor-pointer {% if forloop.first %}active{% endif %}">
                {% endfor %}
            </div>
            {% endif %}
        </div>

        <!-- Product Details -->
        <div class="space-y-6">
            <!-- Title and Price -->
            <div class="space-y-4">
                <h1 class="text-3xl font-bold text-gray-900 dark:text-white">{{ product.title }}</h1>
                
                <div class="flex items-center justify-between">
                    <div class="price-badge text-2xl">
                        {{ product.price|floatformat:0 }} FCFA
                    </div>
                    <span class="condition-badge condition-{{ product.condition|lower }}">
                        {{ product.get_condition_display }}
                    </span>
                </div>
            </div>

            <!-- Description -->
            <div class="bg-gray-50 dark:bg-gray-800 rounded-lg p-6">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-3">Description</h3>
                <p class="text-gray-700 dark:text-gray-300 leading-relaxed">{{ product.description|linebreaks }}</p>
            </div>

            <!-- Product Info -->
            <div class="grid grid-cols-2 gap-4">
                <div class="bg-gray-50 dark:bg-gray-800 rounded-lg p-4">
                    <div class="flex items-center space-x-2">
                        <i data-lucide="map-pin" class="w-5 h-5 text-blue-500"></i>
                        <span class="text-gray-700 dark:text-gray-300">Ville</span>
                    </div>
                    <p class="font-semibold text-gray-900 dark:text-white mt-1">{{ product.get_city_display }}</p>
                </div>
                
                <div class="bg-gray-50 dark:bg-gray-800 rounded-lg p-4">
                    <div class="flex items-center space-x-2">
                        <i data-lucide="eye" class="w-5 h-5 text-blue-500"></i>
                        <span class="text-gray-700 dark:text-gray-300">Vues</span>
                    </div>
                    <p class="font-semibold text-gray-900 dark:text-white mt-1">{{ product.views_count|default:0 }}</p>
                </div>
            </div>

            <!-- Add to Cart Section -->
            <div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-6">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Ajouter au panier</h3>
                
                <div class="space-y-4">
                    <!-- Quantity Selector -->
                    <div class="flex items-center space-x-4">
                        <label class="text-gray-700 dark:text-gray-300 font-medium">Quantité:</label>
                        <div class="flex items-center space-x-2">
                            <button onclick="decreaseQuantity()" class="quantity-btn" id="decrease-btn">
                                <i data-lucide="minus" class="w-4 h-4"></i>
                            </button>
                            <input type="number" id="quantity" value="1" min="1" max="99" 
                                   class="quantity-input w-16">
                            <button onclick="increaseQuantity()" class="quantity-btn" id="increase-btn">
                                <i data-lucide="plus" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="flex flex-col sm:flex-row gap-3">
                        <button onclick="addToCart()" id="add-to-cart-btn" 
                                class="action-button btn-primary flex-1">
                            <i data-lucide="shopping-cart" class="w-5 h-5"></i>
                            <span>Ajouter au panier</span>
                        </button>
                        
                        <button onclick="toggleFavorite()" id="favorite-btn" 
                                class="action-button btn-outline">
                            <i data-lucide="heart" class="w-5 h-5"></i>
                            <span>Favoris</span>
                        </button>
                    </div>

                    <!-- WhatsApp Button -->
                    <a href="{{ whatsapp_url }}" target="_blank" class="whatsapp-button w-full justify-center">
                        <i data-lucide="message-circle" class="w-5 h-5"></i>
                        <span>Contacter le vendeur</span>
                    </a>
                </div>
            </div>

            <!-- Seller Information -->
            <div class="seller-card p-6">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Vendeur</h3>
                <div class="flex items-center space-x-4">
                    <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center text-white font-bold">
                        {{ product.seller.first_name.0|upper }}
                    </div>
                    <div>
                        <p class="font-semibold text-gray-900 dark:text-white">{{ product.seller.get_full_name }}</p>
                        <p class="text-sm text-gray-600 dark:text-gray-400">Membre depuis {{ product.seller.date_joined|date:"M Y" }}</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Similar Products -->
    {% if similar_products %}
    <div class="mt-16">
        <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-8">Produits similaires</h2>
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
            {% for similar in similar_products %}
            <div class="similar-product">
                <img src="{{ similar.main_image.image.url|default:'/static/backend/images/placeholder.jpg' }}" 
                     alt="{{ similar.title }}" 
                     class="w-full h-48 object-cover">
                <div class="p-4">
                    <h3 class="font-semibold text-gray-900 dark:text-white mb-2">{{ similar.title|truncatechars:40 }}</h3>
                    <p class="text-lg font-bold text-green-600">{{ similar.price|floatformat:0 }} FCFA</p>
                    <div class="flex items-center justify-between mt-3">
                        <span class="text-sm text-gray-600 dark:text-gray-400">{{ similar.get_city_display }}</span>
                        <a href="{% url 'backend:visitor_product_detail' similar.slug %}" 
                           class="text-blue-600 hover:text-blue-800 text-sm font-medium">
                            Voir détails
                        </a>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
</div>

<!-- Cart Success Notification -->
<div id="cart-notification" class="cart-success">
    <div class="flex items-center space-x-3">
        <i data-lucide="check-circle" class="w-6 h-6"></i>
        <div>
            <p class="font-semibold">Produit ajouté au panier!</p>
            <p class="text-sm opacity-90">Vérifiez votre panier pour continuer</p>
        </div>
    </div>
</div>

<script>
    let currentImageIndex = 0;
    const images = [
        {% for image in product.images.all %}
        '{{ image.image.url }}',
        {% endfor %}
    ];

    function changeMainImage(src, thumbnail) {
        document.getElementById('main-image').src = src;
        
        // Update active thumbnail
        document.querySelectorAll('.thumbnail').forEach(t => t.classList.remove('active'));
        thumbnail.classList.add('active');
        
        // Update current index
        currentImageIndex = images.indexOf(src);
    }

    function nextImage() {
        if (images.length > 1) {
            currentImageIndex = (currentImageIndex + 1) % images.length;
            changeMainImage(images[currentImageIndex], document.querySelectorAll('.thumbnail')[currentImageIndex]);
        }
    }

    function previousImage() {
        if (images.length > 1) {
            currentImageIndex = (currentImageIndex - 1 + images.length) % images.length;
            changeMainImage(images[currentImageIndex], document.querySelectorAll('.thumbnail')[currentImageIndex]);
        }
    }

    function increaseQuantity() {
        const input = document.getElementById('quantity');
        const value = parseInt(input.value) || 1;
        if (value < 99) {
            input.value = value + 1;
        }
        updateQuantityButtons();
    }

    function decreaseQuantity() {
        const input = document.getElementById('quantity');
        const value = parseInt(input.value) || 1;
        if (value > 1) {
            input.value = value - 1;
        }
        updateQuantityButtons();
    }

    function updateQuantityButtons() {
        const input = document.getElementById('quantity');
        const value = parseInt(input.value) || 1;
        
        document.getElementById('decrease-btn').disabled = value <= 1;
        document.getElementById('increase-btn').disabled = value >= 99;
    }

    function addToCart() {
        const quantity = parseInt(document.getElementById('quantity').value) || 1;
        const button = document.getElementById('add-to-cart-btn');
        const originalContent = button.innerHTML;
        
        // Show loading state
        button.innerHTML = '<div class="loading-spinner"></div><span>Ajout en cours...</span>';
        button.disabled = true;
        
        fetch('{% url "backend:visitor_add_to_cart" product.id %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                quantity: quantity
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showCartNotification();
                // Update cart count if available
                const cartCount = document.getElementById('cart-count');
                if (cartCount) {
                    cartCount.textContent = data.cart_items;
                }
            } else {
                alert('Erreur: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Erreur lors de l\'ajout au panier');
        })
        .finally(() => {
            // Restore button state
            button.innerHTML = originalContent;
            button.disabled = false;
        });
    }

    function toggleFavorite() {
        const button = document.getElementById('favorite-btn');
        const icon = button.querySelector('i');
        
        fetch('{% url "backend:visitor_toggle_favorite" product.id %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                if (data.is_favorite) {
                    icon.setAttribute('data-lucide', 'heart');
                    icon.style.fill = '#ef4444';
                    icon.style.color = '#ef4444';
                } else {
                    icon.setAttribute('data-lucide', 'heart');
                    icon.style.fill = 'none';
                    icon.style.color = 'currentColor';
                }
                lucide.createIcons();
            }
        })
        .catch(error => {
            console.error('Error:', error);
        });
    }

    function showCartNotification() {
        const notification = document.getElementById('cart-notification');
        notification.classList.add('show');
        
        setTimeout(() => {
            notification.classList.remove('show');
        }, 3000);
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
        updateQuantityButtons();
        
        // Update quantity buttons when input changes
        document.getElementById('quantity').addEventListener('input', updateQuantityButtons);
        
        // Initialize Lucide icons
        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        }
    });
</script>
{% endblock %} 